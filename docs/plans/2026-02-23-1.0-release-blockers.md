# 1.0 Release Blockers Implementation Plan

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Close all P0/P1 issues blocking the TagLib-Wasm 1.0 release.

**Architecture:** Remove the Workers API entirely (0 users, WASI covers all platforms including Cloudflare Workers). Fix WASI PropertyMap extended writes. Add deprecation warnings. Fill documentation gaps. Add dual-backend test coverage.

**Tech Stack:** TypeScript (Deno), C++ (WASI shim), MessagePack encoding

**Design doc:** `docs/plans/2026-02-23-1.0-release-blockers-design.md`

---

## Task 0: Close simple.ts Split (Already Done)

`src/simple/` is already a directory module with 6 files, all under 250 lines. Close `e34` immediately.

**Step 1: Close the issue**

```bash
bd close taglib-wasm-e34 --reason="Already split into src/simple/ directory module (6 files, all <250 lines)"
```

---

## Task 1: Remove Workers API

Remove both the Cloudflare Workers API (`src/workers/`) and the Web Workers thread pool (`src/worker-pool/`). Both are superseded by the unified WASI-based `TagLib` API.

**Files to delete:**

- `src/workers/index.ts`
- `src/workers/taglib-workers.ts`
- `src/workers/audio-file-workers.ts`
- `src/workers/taglib-worker.ts`
- `src/workers/batch-handler.ts`
- `src/wasm-workers.ts`
- `src/worker-pool/index.ts`
- `src/worker-pool/types.ts`
- `src/worker-pool/pool.ts`
- `src/worker-pool/global-pool.ts`
- `src/worker-pool/pool-initialization.ts`
- `workers.ts` (root export)
- `examples/workers/` (entire directory)
- `tests/workers-api.test.ts`

**Files to modify:**

- `index.ts` — remove Workers and worker-pool exports
- `mod.ts` — remove Workers exports
- `src/errors/classes.ts` — remove `WorkerError`
- `src/errors/index.ts` — remove `WorkerError` export and `isWorkerError` re-export
- `src/errors/guards.ts` — remove `isWorkerError()`
- `src/simple/config.ts` — remove `setWorkerPoolMode()`, `setBufferMode()`, `getActiveWorkerPool()` and worker pool imports
- `src/simple/index.ts` — remove worker pool function exports
- `deno.json` — remove `"./workers"` export
- `package.json` — remove `"./workers"` export

**Docs to update:**

- `docs/advanced/cloudflare-workers.md` — rewrite to show unified API on Cloudflare Workers
- `docs/guide/workers-setup.md` — remove or redirect
- `README.md` — remove Workers API references
- `LLMs.md` — remove Workers API references

### Steps

**Step 1: Delete all Workers API files**

```bash
rm -rf src/workers/ src/worker-pool/ src/wasm-workers.ts workers.ts examples/workers/ tests/workers-api.test.ts docs/guide/workers-setup.md
```

**Step 2: Remove Workers exports from index.ts**

Remove these export blocks from `index.ts`:

- The `WorkerError` and `isWorkerError` imports/exports from the errors section
- The entire `// Worker pool` export block (`createWorkerPool`, `getGlobalWorkerPool`, `TagLibWorkerPool`, `terminateGlobalWorkerPool`, `BatchOperation`, `WorkerPoolOptions`, `WorkerTask`)
- The `AudioFileWorkers`, `TagLibWorkers` exports if present

**Step 3: Remove Workers exports from mod.ts**

Remove the `AudioFileWorkers`, `TagLibWorkers` export line.

**Step 4: Remove WorkerError from error modules**

In `src/errors/classes.ts`: remove the `WorkerError` class definition.
In `src/errors/index.ts`: remove `WorkerError` from imports and exports.
In `src/errors/guards.ts`: remove the `isWorkerError()` function.

**Step 5: Remove worker pool functions from simple API**

In `src/simple/config.ts`: remove `setWorkerPoolMode()`, `setBufferMode()`, `getActiveWorkerPool()`, and all `TagLibWorkerPool`/`getGlobalWorkerPool` imports.
In `src/simple/index.ts`: remove re-exports of these functions.
In `src/simple/tag-operations.ts`: remove any `getActiveWorkerPool()` calls (functions should use `getTagLib()` directly).
In `src/simple/batch-operations.ts`: remove worker pool delegation paths.

**Step 6: Remove Workers from deno.json and package.json**

In `deno.json`: remove `"./workers": "./workers.ts"` from exports.
In `package.json`: remove the `"./workers"` export entry.

**Step 7: Rewrite docs/advanced/cloudflare-workers.md**

Rewrite to show how to use the unified `TagLib` API on Cloudflare Workers. Key points:

- Import from `@charlesw/taglib-wasm`
- Use `TagLib.initialize()` then `taglib.read()`/`taglib.edit()`
- No special Workers API needed
- Show a minimal Cloudflare Worker handler example

**Step 8: Update README.md and LLMs.md**

Remove references to:

- `TagLibWorkers` / `AudioFileWorkers`
- Worker pool functions
- The `@charlesw/taglib-wasm/workers` import path
- Any "Workers API" sections

**Step 9: Run tests**

```bash
deno task test
```

All tests must pass. Workers-specific tests are deleted, so test count will decrease.

**Step 10: Commit**

```bash
git add -A && git commit -m "feat!: remove Workers API in favor of unified WASI-based API

BREAKING CHANGE: TagLibWorkers, AudioFileWorkers, WorkerError,
createWorkerPool, getGlobalWorkerPool, setWorkerPoolMode, and
setBufferMode have been removed. Use the unified TagLib API instead,
which works on all platforms including Cloudflare Workers."
```

**Step 11: Close beads issues**

```bash
bd close taglib-wasm-ai8 taglib-wasm-v7k taglib-wasm-qea taglib-wasm-gnp taglib-wasm-0nl taglib-wasm-cgo taglib-wasm-0ce --reason="Workers API removed"
bd close taglib-wasm-jzw taglib-wasm-a4j --reason="Workers/worker-pool code removed"
```

Also close `taglib-wasm-5hh` (broken githooks) if it was Workers-related, and check if `taglib-wasm-kit` (stale build scripts) overlaps.

---

## Task 2: WASI PropertyMap Extended Writes (P0)

The C++ shim's `decode_msgpack_to_propmap()` already accepts uppercase keys (line 289-291 of taglib_shim.cpp) and `apply_propmap()` calls `file->setProperties(propMap)`. The TypeScript `CAMEL_TO_VORBIS` mapping (from `src/types/metadata-mappings.ts`) already covers all ~30 extended fields. The gap may be smaller than expected — verify with tests first.

**Files:**

- Test: `tests/wasi-write-roundtrip.test.ts` (add extended field tests)
- Possibly modify: `src/msgpack/encoder.ts` (if encoding gap found)
- Possibly modify: `src/capi/taglib_shim.cpp` (if C++ filter gap found)

### Steps

**Step 1: Write failing roundtrip test for extended fields**

Add to `tests/wasi-write-roundtrip.test.ts`:

```typescript
Deno.test("extended fields roundtrip via PropertyMap", async () => {
  const taglib = await TagLib.initialize();
  const original = await Deno.readFile("tests/fixtures/sample.mp3");

  const tags = {
    title: "Test",
    artist: "Artist",
    albumArtist: "Album Artist",
    composer: "Composer",
    discNumber: 2,
    bpm: 120,
  };

  const modified = await taglib.applyTagsToBuffer(original, tags);
  const result = await taglib.read(modified);

  assertEquals(result.tag.albumArtist, "Album Artist");
  assertEquals(result.tag.composer, "Composer");
  assertEquals(result.tag.discNumber, 2);
  assertEquals(result.tag.bpm, 120);
});
```

**Step 2: Run test to check if it already passes**

```bash
deno test --allow-read --allow-write --allow-env tests/wasi-write-roundtrip.test.ts
```

If it passes, the write path already works and this is just a test coverage gap. If it fails, proceed to Steps 3-4.

**Step 3: (If needed) Fix TypeScript encoder**

In `src/msgpack/encoder.ts`, verify `encodeTagData()` maps all extended fields via `CAMEL_TO_VORBIS`. The fallback `CAMEL_TO_VORBIS[key] ?? key` should pass through unmapped keys as-is, but check that extended field keys ARE in the mapping.

**Step 4: (If needed) Fix C++ shim filter**

In `src/capi/taglib_shim.cpp`, if `should_skip()` or `map_camel_to_prop()` drops extended keys, relax the filter. The key logic at lines 286-291:

- If `map_camel_to_prop(key)` returns a match → use mapped key
- If `is_uppercase_key(key)` → accept as-is
- Otherwise → discard

Extended fields should arrive as UPPERCASE after TypeScript encoding, so they should hit the second case. If not, trace the actual msgpack bytes.

**Step 5: Add MusicBrainz/ReplayGain roundtrip test**

Test arbitrary PropertyMap keys that go beyond the basic extended fields:

```typescript
Deno.test("MusicBrainz fields roundtrip", async () => {
  // Write musicbrainzTrackId, verify it reads back
});
```

**Step 6: Run full test suite**

```bash
deno task test
```

**Step 7: Commit**

```bash
git commit -m "fix: support extended PropertyMap field writes in WASI path"
```

**Step 8: Close beads issue**

```bash
bd close taglib-wasm-k94 --reason="Extended PropertyMap writes verified working"
```

---

## Task 3: Deprecation Warnings + README

With Workers API removed, only two deprecated functions remain: `applyTags()` (use `applyTagsToBuffer()`) and `updateTags()` (use `writeTagsToFile()`).

**Files:**

- Modify: `src/simple/tag-operations.ts` (add console.warn to both functions)
- Modify: `README.md` (update examples to use current names)
- Test: verify warnings emit

### Steps

**Step 1: Add deprecation warnings**

In `src/simple/tag-operations.ts`, add at the top of `applyTags()` (around line 39):

```typescript
console.warn("applyTags() is deprecated. Use applyTagsToBuffer() instead.");
```

Add at the top of `updateTags()` (around line 81):

```typescript
console.warn("updateTags() is deprecated. Use writeTagsToFile() instead.");
```

**Step 2: Write test for deprecation warnings**

Add test verifying `console.warn` is called when deprecated functions are invoked.

**Step 3: Update README examples**

Replace any `applyTags(` with `applyTagsToBuffer(` and `updateTags(` with `writeTagsToFile(` in README.md examples.

**Step 4: Run tests**

```bash
deno task test
```

**Step 5: Commit**

```bash
git commit -m "fix: emit deprecation warnings for applyTags() and updateTags()"
```

**Step 6: Close beads issues**

```bash
bd close taglib-wasm-c8q taglib-wasm-r8x --reason="Deprecation warnings added, README updated"
```

---

## Task 4: Document edit() and copyWithTags()

Both methods exist on the `TagLib` class (`src/taglib/taglib-class.ts`) but lack complete API documentation.

**Files:**

- Modify: `docs/api/index.md`

### Steps

**Step 1: Read current documentation**

Read `src/taglib/taglib-class.ts` to get exact signatures and JSDoc for `edit()` and `copyWithTags()`.
Read `docs/api/index.md` to see current state.

**Step 2: Add edit() documentation**

Add a section to `docs/api/index.md` documenting:

- `taglib.edit(path, fn)` — edit file in place
- `taglib.edit(buffer, fn)` — returns modified buffer
- Show example with method chaining inside the callback

**Step 3: Add copyWithTags() documentation**

Add a section documenting:

- `taglib.copyWithTags(sourcePath, destPath, tags)` — copy file with new tags
- Show example use case

**Step 4: Commit**

```bash
git commit -m "docs: document TagLib.edit() and TagLib.copyWithTags() methods"
```

**Step 5: Close beads issue**

```bash
bd close taglib-wasm-2us --reason="API documentation added for edit() and copyWithTags()"
```

---

## Task 5: Dual-Backend Tests

Parameterize Emscripten-dependent test suites to also run against the WASI backend.

**Files:**

- Modify: test files that currently only test Emscripten
- Possibly create: `tests/test-helpers.ts` backend parameterization utility

### Steps

**Step 1: Identify Emscripten-only tests**

Search for tests that import/initialize Emscripten specifically and don't have WASI equivalents.

**Step 2: Create backend parameterization helper**

Create a utility that runs the same test body against both backends:

```typescript
function forEachBackend(name: string, fn: (taglib: TagLib) => Promise<void>) {
  Deno.test(`${name} [emscripten]`, async () => { ... });
  Deno.test(`${name} [wasi]`, async () => { ... });
}
```

**Step 3: Convert tests to use both backends**

Apply the helper to Emscripten-dependent tests.

**Step 4: Run full suite**

```bash
deno task test
```

**Step 5: Commit**

```bash
git commit -m "test: run core tests against both Emscripten and WASI backends"
```

**Step 6: Close beads issue**

```bash
bd close taglib-wasm-h5x --reason="Tests parameterized for both backends"
```

---

## Summary

| Task                          | Issues Closed                               | Effort                |
| ----------------------------- | ------------------------------------------- | --------------------- |
| 0. Close e34                  | e34                                         | Trivial               |
| 1. Remove Workers API         | ai8, v7k, qea, gnp, 0nl, cgo, 0ce, jzw, a4j | Large (many files)    |
| 2. PropertyMap writes         | k94                                         | Medium (verify + fix) |
| 3. Deprecation warnings       | c8q, r8x                                    | Small                 |
| 4. Document edit/copyWithTags | 2us                                         | Small                 |
| 5. Dual-backend tests         | h5x                                         | Medium                |

**Execution order:** 0 → 1 → 2 → 3 → 4 → 5
Tasks 3 and 4 can run in parallel after Task 2.
